-- Drop the constraint if it exists
ALTER TABLE IF EXISTS "egg_prices" DROP CONSTRAINT IF EXISTS "egg_prices_storeId_date_eggType_key";

-- Add the store_location_id column if it doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'egg_prices' AND column_name = 'store_location_id') THEN
        ALTER TABLE "egg_prices" ADD COLUMN "store_location_id" INTEGER;
    END IF;
END
$$;

-- Make sure eggType is properly cased
ALTER TABLE "egg_prices" RENAME COLUMN IF EXISTS "eggtype" TO "eggType";

-- Create a unique constraint for the new columns
ALTER TABLE "egg_prices" ADD CONSTRAINT IF NOT EXISTS "egg_prices_store_location_id_date_eggType_key" 
UNIQUE ("store_location_id", "date", "eggType");

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS "egg_prices_store_location_id_idx" ON "egg_prices"("store_location_id");
CREATE INDEX IF NOT EXISTS "egg_prices_date_idx" ON "egg_prices"("date");

