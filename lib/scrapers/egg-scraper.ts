import { Pool } from "pg"

async function albertsonsScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Albertsons scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function aldiScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Aldi scraper...")
  return {
    regularPrice: Math.random() * 4 + 2,
    organicPrice: null,
  }
}

async function food4lessScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Food 4 Less scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: null,
  }
}

async function hebScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running H-E-B scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function krogerScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Kroger scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function meijerScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Meijer scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function publixScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Publix scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function safewayScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Safeway scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function sproutsScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Sprouts scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function targetScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Target scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function traderjoesScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Trader Joe's scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function walmartScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Walmart scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function wegmansScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Wegmans scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function wholefoodsScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  // Placeholder logic - replace with actual scraping
  console.log("Running Whole Foods scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function erewhonScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Erewhon scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function foodlionScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Food Lion scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: null,
  }
}

async function gianteagleScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Giant Eagle scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function ralphsScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Ralphs scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function shopriteScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running ShopRite scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function stopandshopScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Stop & Shop scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function vonsScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Vons scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function winndixieScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Winn-Dixie scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: null,
  }
}

async function weismarketsScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Weis Markets scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

async function harristeeterScraper(): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  console.log("Running Harris Teeter scraper...")
  return {
    regularPrice: Math.random() * 5 + 2,
    organicPrice: Math.random() * 8 + 4,
  }
}

const scrapers: { [key: string]: () => Promise<{ regularPrice: number | null; organicPrice: number | null }> } = {
  albertsons: albertsonsScraper,
  aldi: aldiScraper,
  food4less: food4lessScraper,
  heb: hebScraper,
  kroger: krogerScraper,
  meijer: meijerScraper,
  publix: publixScraper,
  safeway: safewayScraper,
  sprouts: sproutsScraper,
  target: targetScraper,
  traderjoes: traderjoesScraper,
  walmart: walmartScraper,
  wegmans: wegmansScraper,
  wholefoods: wholefoodsScraper,
  erewhon: erewhonScraper,
  foodlion: foodlionScraper,
  gianteagle: gianteagleScraper,
  ralphs: ralphsScraper,
  shoprite: shopriteScraper,
  stopandshop: stopandshopScraper,
  vons: vonsScraper,
  winndixie: winndixieScraper,
  weismarkets: weismarketsScraper,
  harristeeter: harristeeterScraper,
}

export async function scrapeStore(
  storeId: string,
): Promise<{ regularPrice: number | null; organicPrice: number | null }> {
  const scraper = scrapers[storeId]

  if (!scraper) {
    console.warn(`No scraper found for store ID: ${storeId}`)
    return { regularPrice: null, organicPrice: null }
  }

  try {
    return await scraper()
  } catch (error) {
    console.error(`Scraping failed for ${storeId}:`, error)
    return { regularPrice: null, organicPrice: null }
  }
}

// Update the savePrices function to handle null prices
export async function savePrices(
  storeId: string,
  regularPrice: number | null,
  organicPrice: number | null,
): Promise<boolean> {
  const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
  })

  try {
    // Get today's date at midnight
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    const formattedDate = today.toISOString().split("T")[0]

    // Insert prices if they exist
    if (regularPrice !== null) {
      const regularId = `${storeId}-${formattedDate}-regular`
      await pool.query(
        `INSERT INTO egg_prices (id, "storeId", price, date, "eggType") 
         VALUES ($1, $2, $3, $4, $5) 
         ON CONFLICT ("storeId", date, "eggType") DO UPDATE 
         SET price = $3`,
        [regularId, storeId, regularPrice, formattedDate, "regular"],
      )
    } else {
      // If price is null, we still want to record that we attempted to scrape
      // but found no data
      const regularId = `${storeId}-${formattedDate}-regular`
      await pool.query(
        `INSERT INTO egg_prices (id, "storeId", price, date, "eggType") 
         VALUES ($1, $2, NULL, $3, $4) 
         ON CONFLICT ("storeId", date, "eggType") DO UPDATE 
         SET price = NULL`,
        [regularId, storeId, formattedDate, "regular"],
      )
    }

    if (organicPrice !== null) {
      const organicId = `${storeId}-${formattedDate}-organic`
      await pool.query(
        `INSERT INTO egg_prices (id, "storeId", price, date, "eggType") 
         VALUES ($1, $2, $3, $4, $5) 
         ON CONFLICT ("storeId", date, "eggType") DO UPDATE 
         SET price = $3`,
        [organicId, storeId, organicPrice, formattedDate, "organic"],
      )
    } else {
      // If price is null, we still want to record that we attempted to scrape
      // but found no data
      const organicId = `${storeId}-${formattedDate}-organic`
      await pool.query(
        `INSERT INTO egg_prices (id, "storeId", price, date, "eggType") 
         VALUES ($1, $2, NULL, $3, $4) 
         ON CONFLICT ("storeId", date, "eggType") DO UPDATE 
         SET price = NULL`,
        [organicId, storeId, formattedDate, "organic"],
      )
    }

    await pool.end()
    return true
  } catch (error) {
    console.error(`Error saving prices for ${storeId}:`, error)

    // Make sure to close the pool even on error
    try {
      await pool.end()
    } catch (closeError) {
      console.error("Error closing pool:", closeError)
    }

    return false
  }
}

